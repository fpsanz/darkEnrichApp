---
title: "RNAseq enrichment report"
author: ""
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  rmdformats::readthedown:
    highlight: kate
params:
  tempdir: NA
  values: NA
  pcaObj: NA
  rlog: NA
  colorespca: NA
  variables: NA
  samplename: NA
  boxObj: NA
  vsd: NA
  boxplotswitch: NA
  heatObj: NA
  specie: NA
  numheatmap: NA
  clusterObj: NA
  top6Obj: NA
  ressh: NA
  datosdds: NA
  top1Obj: NA
  gene: NA
  karyObj: NA
  padj: NA
  logfc: NA
  upcolor: NA
  downcolor: NA
  volcObj: NA
  maObj: NA
  genesvolcano: NA
  tablekgaObj: NA
  kggall: NA
  genesdedown: NA
  genesdeup: NA
  kggdtall: NA
  barkgaObj: NA
  nparams$nrowsall: NA
  datagenesdown: NA
  datagenesup: NA
  typebarkeggall: NA
  dotkgaObj: NA
  chorkgaObj: NA
  heatkgaObj: NA
  netkgaObj: NA
  nrowsall: NA
---


```{r results="asis", echo=FALSE}
cat("
<style>
#content {
  max-width: 1080px;
  margin-left: 300px;
  background: #edf0f2;
}
</style>
")
```

```{r setup, echo=FALSE, include=FALSE, comment=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, out.width='100%',
                      comment = FALSE, message = FALSE)
setwd(params$tempdir)
library("scales")
library("shinydashboard")
library("limma")
library("tidyverse")
library("DT")
library("purrr")
library("plotly")
library("DESeq2")
library("ggraph")
library("igraph")
library("edgeR")
library("PoiClaClu")
library("ggplot2")
library("pheatmap")
library("RColorBrewer")
library("knitr")
library("apeglm")
library("calibrate")
library("AnnotationDbi")
library('org.Mm.eg.db')
library('AnnotationHub')
library('plotly')
library('topGO')
library('Rgraphviz')
library("BiocParallel")
library('clusterProfiler')
library('pathview')
library('gage')
library('ggpubr')
library('gageData')
library('EnsDb.Mmusculus.v79')
library('EnhancedVolcano')
library('gplots')
source("utils.R")

if(!is.null(params$values$preview)){preview=TRUE}else{preview=FALSE}
```

```{r previewTitle, eval=preview, results='asis'}
cat("# Preview section")
```

```{r pcatitle, eval = params$pcaObj, results='asis'}
cat("## PCA 2D")
```


```{r pca2d, eval=params$pcaObj}
    plotPCA(
        params$rlog,
        intgroup = params$variables,
        labels = params$samplename,
        customColor = params$colorespca
    ) +
        theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm")) +
        scale_size_manual(values = 3) +
        theme(text = element_text(size = 16))
```

```{r boxplotitle, eval=params$boxObj, results='asis' }
cat("## Box/Violin plot")
```

```{r boxplot, eval=params$boxObj }
boxViolin( names = params$samplename , vsd=params$vsd, boxplotswitch=params$boxplotswitch,
                    intgroup=params$variables, customColor = params$colorespca ) 
```

```{r heatmaptitle, eval=params$heatObj, results='asis'}
cat("## Heatmap")
```

```{r heatmap, eval=params$heatObj}
heat2(params$vsd, n=params$numheatmap, intgroup = params$variables, sampleName = params$samplename,
         specie=params$specie, customColor = params$colorespca )
```

```{r clustertitle, eval=params$clusterObj, results='asis'}
cat("## Cluster")
```

```{r cluster, eval=params$clusterObj}
cluster(params$vsd, intgroup = params$samplename)
```

```{r top6title, eval=params$top6Obj, results='asis'}
cat("## Top 6 genes")
```

```{r top6, eval=params$top6Obj}
topGenes <- rownames(params$ressh)[order(params$ressh$padj)][1:6]
topSymbol <- as.character(params$ressh$GeneName_Symbol)[order(params$ressh$padj)][1:6]
z <- lapply(topGenes, function(x) plotCounts(dds=params$datosdds, gene=x,
                                             res=params$ressh, intgroup = params$variables,
                                             returnData = TRUE))
z <- lapply(z, function(x){x %>% group_by(!!as.name(params$variables[1])) %>%
    mutate(mean = round(mean(count),2), sem = round(sd(count)/sqrt(n()),3 ), n = n() ) %>%
    mutate(text = paste0("Mean: ",mean,"\n","SEM: ",sem)) } )
z <- do.call(rbind, z)
z$symbol <- rep(topSymbol, each =(nrow(z)/6) )
z[[params$variables[1]]] <- as.factor(z[[params$variables[1]]])
p <- ggplot(z, aes_(as.name(params$variables), ~count, colour = as.name(params$variables[1] ), text = ~text ) ) +
  scale_y_log10() +
  geom_point(position = position_jitter(width = 0.1, height = 0), size = 2) +
  facet_wrap(~symbol) + scale_color_manual( values = params$colorespca ) +
  ggtitle("Expression of top 6 most significant genes")
p %>% ggplotly(tooltip = c("x","y","text"))
```

```{r top1title, eval = params$top1Obj, results = 'asis' }
cat("## Top 1 gene")
```

```{r top1, eval = params$top1Obj}
if (grepl("^ENS", params$gene, ignore.case = TRUE)) {
        gene <- toupper(params$gene)
        z <- plotCounts(dds = params$datosdds,gene = gene, returnData = TRUE,
                        intgroup = params$variables[1])
        symbol = as.character(params$ressh$GeneName_Symbol[rownames(params$ressh) == gene])
    } else{
        if (params$specie == "Mm" | params$specie == "Rn") {
            gene <- stringr::str_to_title(params$gene)
        }
        else{
            gene = toupper(params$gene)
        }
        z <- plotCountsSymbol(dds = params$datosdds, gene = gene, returnData = TRUE,
                              intgroup = params$variables[1], specie=params$specie )
        symbol <- gene
    }
    z <- z %>% group_by(!!as.name(params$variables[1])) %>%
        mutate(mean = round(mean(count),2), sem = round(sd(count)/sqrt(n()),3 ), n = n() ) %>% 
        mutate(text = paste0("Mean: ",mean,"\n","SEM: ",sem))
    p <- z %>% ggplot(aes_(as.name(params$variables[1]), ~count, colour = as.name(params$variables[1] ),
                           text = ~text) ) + scale_y_log10() +
        geom_point(position = position_jitter(width = 0.1, height = 0), size = 2)+
        scale_color_manual( values = params$colorespca )+
        ggtitle(paste0(symbol) )
    p
```

```{r karyotitle, eval=params$karyObj, results='asis' }
cat("## Karyoplot")
```

```{r karyoplot, eval=params$karyObj}
    krtp(params$ressh, specie = params$specie, pval = params$padj, fcdown = params$logfc[1],
         fcup = params$logfc[2], bg="#46505a", coldown="#4ADBFF" , colup="#f7665c")
```

```{r volcanotitle, eval = params$volcObj, results='asis' }
cat("## Volcano plot")
```

```{r volcanoplot, eval = params$volcObj}
CustomVolcano( params$ressh,
  lab = as.character(params$ressh$GeneName_Symbol),
  selectLab = params$genesvolcano,
  x = 'log2FoldChange',
  y = 'padj',
  pCutoff = params$padj,
  FCcutoffUP = params$logfc[2],
  FCcutoffDOWN = params$logfc[1],
  xlim = c(-8, 8),
  col = c("gray", "#7cccc3", "#d99c01", params$upcolor, params$downcolor)
)
```


```{r MAtitle, eval = params$maObj, results='asis' }
cat("## MA plot")
```

```{r MAplot, eval = params$maObj}
MA(params$ressh, main = 'MA plot applying the DESeq2 Shrinkage normalization for Foldchange',
       fdr = params$padj, fcDOWN = params$logfc[1], fcUP = params$logfc[2] , size = 1.5,
       palette = c(params$upcolor, params$downcolor, "gray"),
       genenames = params$ressh$GeneName_Symbol,
       legend = "top", top = 15, select.top.method = c('padj','fc'),
       font.label = c("plain", 12),
       font.legend = c("plain", 15),
       font.main = "plain",
       cex.axis = 1.1, cex.lab = 1.3,
       ggtheme = theme_classic()
    )
```


```{r tablekga, eval = params$tablekgaObj, results='asis' }
cat("## Table kegg All genes")
```

```{r tablekgaplot, eval = params$tablekgaObj}
    kggdtall <- params$kggdtall
    names(kggdtall)[names(kggdtall) == "DE"] <- "DEG"
    names(kggdtall)[names(kggdtall) == "P.DE"] <- "p-value"
    tituloTabla <- paste0("Table: Kegg all genes | ","log2FC: ",params$logfc[1],"_",params$logfc[2]," | ",
                          "padj: ",params$padj," | ",
                          "Num genes Up/down: ",params$numgenesdeup,"/",params$numgenesdedown)
    customButtons <- list(
        list(extend = "copy", title=tituloTabla),
        list(extend = "excel",
            filename = "keggAll",
            title = tituloTabla),
        list(extend = "pdf",
            filename = "keggAll",
            title = tituloTabla),
        list(extend = "print", title=tituloTabla)
    )
    datatable2(
      kggdtall, 
      vars = c("genes"),
      filter = list(position="top", clear=FALSE),
      escape = FALSE,
      opts = list(order = list(list(5, 'asc')),
        pageLength = 10, white_space = "normal",
        buttons = customButtons
        ) )
```

```{r barkga, eval = params$barkgaObj, results='asis' }
cat("## Barplot kegg All genes")

```

```{r  eval = params$barkgaObj }
kggall <- params$kggall
p <- plotKeggAll(enrichdf = kggall[params$nrowsall,], nrows = length(params$nrowsall),
                genesUp = params$datagenesup, genesDown = params$datagenesdown,
                colors = c(params$upcolor, params$downcolor))
    if(params$typebarkeggall == "Dodge"){
        (p[[1]])   } else if(params$typebarkeggall=="Stack"){
            (p[[2]])} else {(p[[3]])}
```

```{r chorkga, eval = params$chorkgaObj, results='asis' }
cat("## Chorplot All genes")
```

```{r chorkgaplot, eval = params$chorkgaObj}
chordPlot(params$kggall[params$nrowsall, ], nRows = length(params$nrowsall), orderby = "P.DE")
legendChorplot(params$kggall[params$nrowsall, ] )
```

```{r dotkga, eval = params$dotkgaObj, results='asis' }
cat("## Dotplot kegg All genes")
```

```{r dotkgaplot, eval = params$dotkgaObj}
kggall <- params$kggall
dotPlotkegg(params$kggall[params$nrowsall,], n = length(params$nrowsall))
```

```{r heatkga, eval = params$heatkgaObj, results='asis' }
cat("## Heatmap kegg All genes")
```

```{r heatkgaplot, eval = params$heatkgaObj}
heatmapKeggLogFC(kggDT$all, params$ressh, params$nrowsall ) 
```

```{r netkga, eval = params$netkgaObj, results='asis' }
cat("## Netplot kegg All genes")
```

```{r netkgaplot, eval = params$netkgaObj}
customCnetKegg(params$kggall, params$nrowsall, genesUp = params$datagenesup, genesDown = params$datagenesdown)
```



